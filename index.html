
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GURU - JNTUK R23 Exam Evaluator</title>
  <link rel="icon" href="Logo.ico" type="image/x-icon">

  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    :root {
      --primary-color: #4361ee;
      --primary-light: #eef2ff;
      --secondary-color: #10b981;
      --secondary-light: #d1fae5;
      --dark-color: #1e293b;
      --medium-color: #64748b;
      --light-color: #f8fafc;
      --background-color: #f1f5f9;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --sidebar-width: 280px;
      --fail-color: #ef4444;
      --below-avg-color: #f59e0b;
      --avg-color: #f97316;
      --good-color: #22c55e;
    }

    [data-theme="dark"] {
      --primary-color: #6082fa;
      --primary-light: #1e1b4b;
      --secondary-color: #34d399;
      --secondary-light: #064e3b;
      --dark-color: #f8fafc;
      --medium-color: #94a3b8;
      --light-color: #1e293b;
      --background-color: #0f172a;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.25), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
      --fail-color: #dc2626;
      --below-avg-color: #d97706;
      --avg-color: #ea580c;
      --good-color: #16a34a;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: var(--background-color);
      color: var(--dark-color);
      line-height: 1.5;
      font-size: 14px;
      transition: var(--transition);
      position: relative;
      min-height: 100vh;
      padding-right: 0;
    }

    body.sidebar-open {
      overflow: hidden;
      padding-right: var(--sidebar-width);
    }

    .container {
      max-width: 1000px;
      padding: 1.5rem;
      transition: var(--transition);
    }

    h1, h2, h3, h4 {
      font-weight: 600;
    }

    .card {
      background-color: var(--light-color);
      border: none;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      padding: 1.25rem;
      margin-bottom: 1rem;
      transition: var(--transition);
    }

    h1 {
      font-size: 1.75rem;
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 1.5rem;
    }

    select, .form-select, textarea {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      border-radius: 8px;
      border: 1px solid var(--medium-color);
      transition: var(--transition);
      background-color: var(--light-color);
      color: #6082fa;
    }

    select:focus, .form-select:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.15);
      outline: none;
    }

    .btn {
      font-weight: 500;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    #randomBtn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      height: 100%;
    }

    #randomBtn:hover {
      background-color: #3a56d4;
      transform: translateY(-1px);
    }

    #startExamBtn {
      background-color: var(--secondary-color);
      color: white;
      border: none;
    }

    #startExamBtn:hover {
      background-color: #0e9f74;
      transform: translateY(-1px);
    }

    #startExamBtn:disabled {
      background-color: var(--medium-color);
      cursor: not-allowed;
      transform: none;
      opacity: 0.7;
    }

    #timerDisplay {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-color);
      text-align: center;
      background: var(--light-color);
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      display: inline-block;
      box-shadow: var(--card-shadow);
      margin-bottom: 1rem;
      border: 1px solid var(--primary-light);
    }

    #pdfViewer {
      width: 100%;
      height: 500px;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      margin: 1rem 0;
      display: none;
      border: none;
      background-color: var(--light-color);
    }

    #pdfPreview {
      width: 100%;
      height: 500px;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      margin: 1rem 0;
      border: none;
      background-color: var(--light-color);
    }

    #fileInput {
      width: 100%;
      padding: 1.5rem;
      border: 2px dashed var(--medium-color);
      border-radius: 10px;
      background-color: var(--light-color);
      margin: 1rem 0;
      cursor: pointer;
      transition: var(--transition);
    }

    #fileInput:hover {
      border-color: var(--primary-color);
      background-color: var(--primary-light);
    }

    #submitAnswersBtn {
      background-color: var(--primary-color);
      color: white;
      margin-top: 1rem;
      border: none;
      width: 100%;
    }

    #submitAnswersBtn:hover {
      background-color: #3a56d4;
      transform: translateY(-1px);
    }

    textarea {
      width: 100%;
      min-height: 180px;
      padding: 1rem;
      font-size: 0.9rem;
      border: 1px solid var(--medium-color);
      border-radius: 10px;
      resize: vertical;
      background-color: var(--light-color);
    }

    ul#fileList {
      list-style: none;
      padding: 0;
      margin: 0.75rem 0;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    ul#fileList li {
      background-color: var(--primary-light);
      color: var(--primary-color);
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    ul#fileList li i {
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition);
      font-size: 0.8rem;
    }

    ul#fileList li i:hover {
      opacity: 1;
      color: #ef4444;
    }

    .section-title {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: var(--dark-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title i {
      color: var(--primary-color);
      font-size: 1rem;
    }

    .floating-btn {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
      cursor: pointer;
      transition: var(--transition);
      z-index: 100;
      border: none;
      opacity: 0;
      transform: translateY(20px);
    }

    .floating-btn.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .floating-btn:hover {
      transform: translateY(-2px) scale(1.05);
      background-color: #3a56d4;
    }

    .theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--light-color);
      color: var(--dark-color);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--card-shadow);
      cursor: pointer;
      transition: var(--transition);
      z-index: 100;
      border: none;
    }

    .theme-toggle:hover {
      transform: scale(1.05);
    }

    /* Sidebar styles */
    .sidebar {
      position: fixed;
      top: 0;
      right: -280px;
      width: var(--sidebar-width);
      height: 100vh;
      background-color: var(--light-color);
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transition: var(--transition);
      z-index: 1000;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .sidebar-open .sidebar {
      right: 0;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--medium-color);
    }

    .sidebar-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
    }

    .close-sidebar {
      background: none;
      border: none;
      color: var(--medium-color);
      font-size: 1.25rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .close-sidebar:hover {
      color: var(--primary-color);
      transform: rotate(90deg);
    }

    .history-item {
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-radius: 8px;
      background-color: var(--background-color);
      transition: var(--transition);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-item-content {
      flex: 1;
    }

    .history-item:hover {
      transform: translateX(5px);
      box-shadow: var(--card-shadow);
    }

    .history-subject {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--dark-color);
    }

    .history-date {
      font-size: 0.75rem;
      color: var(--medium-color);
      margin-bottom: 0.25rem;
    }

    .history-score {
      font-weight: 600;
    }

    .score-fail {
      color: var(--fail-color);
    }

    .score-below-avg {
      color: var(--below-avg-color);
    }

    .score-avg {
      color: var(--avg-color);
    }

    .score-good {
      color: var(--good-color);
    }

    .delete-history {
      color: var(--medium-color);
      cursor: pointer;
      transition: var(--transition);
      padding: 0.25rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-history:hover {
      color: #ef4444;
      background-color: rgba(239, 68, 68, 0.1);
    }

    .no-history {
      text-align: center;
      padding: 1rem;
      color: var(--medium-color);
      font-style: italic;
    }

    .sidebar-btn {
      position: fixed;
      top: 1rem;
      left: 1rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--light-color);
      color: var(--dark-color);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--card-shadow);
      cursor: pointer;
      transition: var(--transition);
      z-index: 100;
      border: none;
    }

    .sidebar-btn:hover {
      transform: scale(1.05);
      background-color: var(--primary-light);
    }

    .sidebar-btn .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Exam completion notification */
    .exam-complete-notification {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--secondary-color);
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      z-index: 1000;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .exam-complete-notification.show {
      bottom: 2rem;
    }

    /* Writing instructions */
    .writing-instructions {
      background-color: var(--primary-light);
      border-left: 4px solid var(--primary-color);
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      margin: 1rem 0;
      color: #6082fa;
    }

    .writing-instructions h5 {
      color: #6082fa;
      margin-bottom: 0.5rem;
    }

    .writing-instructions ul {
      padding-left: 1.25rem;
      margin-bottom: 0;
    }

    .writing-instructions li {
      margin-bottom: 0.25rem;
    }

    /* File upload requirements */
    .file-requirements {
      font-size: 0.8rem;
      color: var(--medium-color);
      margin-top: 0.5rem;
    }

    .file-requirements.error {
      color: #ef4444;
    }

    /* PDF preview section */
    .pdf-preview-container {
      margin-bottom: 1.5rem;
    }

    .pdf-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      #pdfViewer, #pdfPreview {
        height: 350px;
      }

      .sidebar {
        width: 90%;
        right: -90%;
      }

      body.sidebar-open {
        padding-right: 90%;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar Button with Badge -->
  <button class="sidebar-btn" id="sidebarToggle">
    <i class="fas fa-history"></i>
    <span class="badge" id="historyBadge">0</span>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3 class="sidebar-title"><i class="fas fa-history me-2"></i>Exam History</h3>
      <button class="close-sidebar" id="closeSidebar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="historyContent">
      <div class="no-history">No exam history yet</div>
    </div>
  </div>

  <!-- Theme Toggle -->
  <button class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
  </button>

  <!-- Exam Completion Notification -->
  <div class="exam-complete-notification" id="examCompleteNotification">
    <i class="fas fa-bell"></i>
    <span>Exam time is over! Please submit your answers.</span>
  </div>

  <div class="container my-3">
    <div class="text-center">
      <p id="timerDisplay" class="mb-3">00:00:00</p>
    </div>
    
    <div class="d-flex align-items-center justify-content-center mb-4" style="gap: 16px;">
      <img 
        src="C:\Users\surya\OneDrive\ONE DRIVE\Desktop\Eval Guru\Base.png" 
        alt="Sample" 
        style="border-radius:8px; width:104px; height:104px; object-fit:cover;"
        class="img-fluid flex-shrink-0"
      >
      <h1 class="mb-0 text-center" style="font-size:clamp(1.25rem,4vw,2.2rem); color: #6082fa;"></h1>
        Eval Guru - AI Exam Evaluator
      </h1>
    </div>

    <div class="card mb-3">
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label for="subjectSelect" class="form-label fw-semibold mb-2" style="color: #6082fa;">
            <i class="fas fa-book-open me-2"></i>Choose Your Subject
          </label>
          <select id="subjectSelect" class="form-select">
            <option value="" disabled selected>-- Select Subject --</option>
            <option value="devc">DEVC (M2)</option>
            <option value="physics">Engineering Physics</option>
            <option value="ds">Data Structures</option>
            <option value="beee">BEEE</option>
          </select>
        </div>

        <div class="col-md-6">
          <button id="randomBtn" class="btn w-100">
            <i class="fas fa-random me-2"></i>Random PYQ
          </button>
        </div>
      </div>
    </div>

    <!-- PDF Preview Section -->
    <div class="pdf-preview-container" id="pdfPreviewContainer" style="display: none;">
      <div class="pdf-preview-header">
        <h3 class="section-title" style="color: #6082fa;"></h3>
          <i class="fas fa-file-pdf me-2"></i>PYQ Preview
        </h3>
        <button id="startExamBtn" class="btn">
          <i class="fas fa-play-circle me-2"></i>Start Exam
        </button>
      </div>
      <iframe id="pdfPreview"></iframe>
    </div>

    <!-- Exam PDF Viewer (shown during exam) -->
    <iframe id="pdfViewer" style="display: none;"></iframe>

    <!-- Writing Instructions (shown during exam) -->
    <div id="writingInstructions" class="writing-instructions" style="display: none;">
      <h5 style="color: #6082fa;"><i class="fas fa-pencil-alt me-2"></i>Writing Time</h5>
      <ul>
        <li>Download or print the question paper if needed</li>
        <li>Write your answers on paper during the exam time</li>
        <li>The upload section will appear when time is up</li>
        <li>Make sure your answers are clear and readable</li>
      </ul>

      <div class="text-center mb-2"></div>
        <div class="d-flex justify-content-end mb-2">
          <p id="timerDisplaySecondary" style="font-size:1.1rem; font-weight:600; color:#6082fa; background:var(--light-color); padding:0.5rem 1.2rem; border-radius:50px; display:inline-block; border:1px solid var(--primary-light); margin-bottom:0;">
          </p>
      </div>
      <script>
        // Mirror timer to secondary display
        const timerDisplaySecondary = document.getElementById('timerDisplaySecondary');
        function updateSecondaryTimerDisplay() {
          timerDisplaySecondary.textContent = timerDisplay.textContent;
          timerDisplaySecondary.style.color = timerDisplay.style.color;
        }
        // Initial sync
        updateSecondaryTimerDisplay();
        // Update on every timer tick
        setInterval(updateSecondaryTimerDisplay, 200);
      </script>

    </div>

    <!-- Upload Section (shown after exam ends) -->
    <div id="uploadSection" class="card" style="display:none; color: #6082fa;">
      <h3 class="section-title" style="color: #6082fa;"></h3>
        <i class="fas fa-cloud-upload-alt"></i>Upload Your Answer Sheets
      </h3>
      <p class="text-muted mb-2">Upload images or PDFs of your answer sheets for evaluation</p>
      <input type="file" id="fileInput" multiple accept="image/*,application/pdf,.doc,.docx" />
      <div class="d-flex justify-content-between align-items-center mt-1">
        <small class="text-muted" style="color: red;">Supports JPG, PNG, PDF, DOC, DOCX</small>
        <small class="text-muted">Max 34 files</small>
      </div>
      <div class="file-requirements" id="fileRequirements">Please upload at least 1 file</div>
      <ul id="fileList" class="mt-2"></ul>
      <button id="submitAnswersBtn" class="btn" style="display:none;">
        <i class="fas fa-paper-plane me-2"></i>Submit for Evaluation
      </button>
    </div>

    <div id="evaluationResult" class="card mt-3" style="display:none;">
      <h3 class="section-title" style="color: #6082fa;">AI Evaluation Result</h3>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <span class="fw-semibold">Subject:</span>
          <span id="resultSubject" class="ms-2">-</span>
        </div>
        <div>
          <span class="fw-semibold">Score:</span>
          <span id="resultScore" class="ms-2">-</span>
        </div>
      </div>
      <textarea id="aiFeedback" rows="12" placeholder="Your evaluation results will appear here..." readonly></textarea>
    </div>
  </div>

  <button class="floating-btn" id="scrollTopBtn">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- Audio element for notification sound -->
  <audio id="notificationSound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5e2.mp3" preload="auto"></audio>

  <!-- Bootstrap JS (Optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
<script>
// === Theme Toggle ===
const themeToggle = document.getElementById('themeToggle');
const html = document.documentElement;
const savedTheme = localStorage.getItem('theme') || 
  (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
html.setAttribute('data-theme', savedTheme);
themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

themeToggle.addEventListener('click', () => {
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
});

// === Scroll To Top ===
const scrollTopBtn = document.getElementById('scrollTopBtn');
window.addEventListener('scroll', () => {
  scrollTopBtn.classList.toggle('visible', window.pageYOffset > 300);
});
scrollTopBtn.addEventListener('click', () => {
  window.scrollTo({top: 0, behavior: 'smooth'});
});

// === Sidebar ===
const sidebarToggle = document.getElementById('sidebarToggle');
const closeSidebar = document.getElementById('closeSidebar');
const sidebar = document.getElementById('sidebar');
const body = document.body;
sidebarToggle.addEventListener('click', () => body.classList.add('sidebar-open'));
closeSidebar.addEventListener('click', () => body.classList.remove('sidebar-open'));
document.addEventListener('click', e => {
  if (!sidebar.contains(e.target) && e.target !== sidebarToggle) {
    body.classList.remove('sidebar-open');
  }
});

// === Timer ===
let timerInterval;
const examDuration = 10;
let timeLeft = parseInt(localStorage.getItem('examTimeLeft')) || examDuration;
const timerDisplay = document.getElementById('timerDisplay');
const notificationSound = document.getElementById('notificationSound');
const examCompleteNotification = document.getElementById('examCompleteNotification');
const writingInstructions = document.getElementById('writingInstructions');
const uploadSection = document.getElementById('uploadSection');
const pdfViewer = document.getElementById('pdfViewer');
const pdfPreview = document.getElementById('pdfPreview');
const pdfPreviewContainer = document.getElementById('pdfPreviewContainer');
const startExamBtn = document.getElementById('startExamBtn');
const subjectSelect = document.getElementById('subjectSelect');
const randomBtn = document.getElementById('randomBtn');
const examInProgress = localStorage.getItem('examInProgress') === 'true';
const selectedPyqUrl = localStorage.getItem('selectedPyqUrl');

if (examInProgress && timeLeft > 0) {
  pdfViewer.src = selectedPyqUrl;
  pdfViewer.style.display = 'block';
  writingInstructions.style.display = 'block';
  startExamBtn.disabled = true;
  subjectSelect.disabled = true;
  randomBtn.disabled = true;
  startTimer();
} else if (timeLeft <= 0) {
  uploadSection.style.display = 'block';
}

function startTimer() {
  clearInterval(timerInterval);
  updateTimerDisplay();
  localStorage.setItem('examInProgress', 'true');
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    localStorage.setItem('examTimeLeft', timeLeft);
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      localStorage.removeItem('examInProgress');
      localStorage.removeItem('examTimeLeft');
      examTimeOver();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const h = Math.floor(timeLeft / 3600).toString().padStart(2, '0');
  const m = Math.floor((timeLeft % 3600) / 60).toString().padStart(2, '0');
  const s = (timeLeft % 60).toString().padStart(2, '0');
  timerDisplay.textContent = `${h}:${m}:${s}`;
  timerDisplay.style.color = timeLeft <= 60 ? '#ef4444' : 'var(--primary-color)';
}

function examTimeOver() {
  notificationSound.play();
  examCompleteNotification.classList.add('show');
  writingInstructions.style.display = 'none';
  uploadSection.style.display = 'block';
  subjectSelect.disabled = false;
  randomBtn.disabled = false;
  setTimeout(() => uploadSection.scrollIntoView({behavior: 'smooth'}), 1000);
  setTimeout(() => examCompleteNotification.classList.remove('show'), 5000);
}

// === Exam History ===
let examHistory = JSON.parse(localStorage.getItem('examHistory')) || [];
const historyContent = document.getElementById('historyContent');
const historyBadge = document.getElementById('historyBadge');

function updateHistoryBadge() {
  historyBadge.textContent = examHistory.length;
}
function getScoreClass(score) {
  if (score < 25) return 'score-fail';
  if (score < 40) return 'score-below-avg';
  if (score < 60) return 'score-avg';
  return 'score-good';
}
function renderHistory() {
  historyContent.innerHTML = examHistory.length
    ? examHistory.slice().reverse().map(exam => `
      <div class="history-item">
        <div class="history-item-content">
          <div class="history-subject">${exam.subject}</div>
          <div class="history-date">${new Date(exam.date).toLocaleString()}</div>
          <div class="history-score ${getScoreClass(exam.score)}">Score: ${exam.score}/70</div>
        </div>
        <div class="delete-history" data-id="${exam.id}"><i class="fas fa-trash"></i></div>
      </div>`).join('')
    : '<div class="no-history">No exam history yet</div>';
  document.querySelectorAll('.delete-history').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      examHistory = examHistory.filter(item => item.id !== id);
      localStorage.setItem('examHistory', JSON.stringify(examHistory));
      updateHistoryBadge();
      renderHistory();
    });
  });
}
function addToHistory(subject, score) {
  const newExam = {id: Date.now().toString(), subject, score, date: new Date().toISOString()};
  examHistory.push(newExam);
  localStorage.setItem('examHistory', JSON.stringify(examHistory));
  updateHistoryBadge();
  renderHistory();
}
updateHistoryBadge();
renderHistory();

// === PYQ Data ===
const pyqData = {
  devc: [{name:'devc-1',url:'./pyqs/devc-1.pdf'},{name:'devc-2',url:'./pyqs/devc-2.pdf'}],
  physics: [{name:'physics-1',url:'./pyqs/physics-1.pdf'},{name:'physics-2',url:'./pyqs/physics-2.pdf'}],
  ds: [{name:'ds-1',url:'./pyqs/ds-1.pdf'},{name:'ds-2',url:'./pyqs/ds-2.pdf'}],
  beee: [{name:'beee-1',url:'./pyqs/beee-1.pdf'},{name:'beee-2',url:'./pyqs/beee-2.pdf'}]
};
subjectSelect.addEventListener('change', function() {
  const subject = this.value;
  if (!subject) return;
  pdfPreviewContainer.style.display = 'block';
  loadPyqPreview(pyqData[subject][0].url);
  setTimeout(() => pdfPreviewContainer.scrollIntoView({behavior:'smooth'}), 300);
});
function loadPyqPreview(url) {
  pdfPreview.src = url;
  localStorage.setItem('selectedPyqUrl', url);
  startExamBtn.disabled = false;
}
randomBtn.addEventListener('click', () => {
  const subject = subjectSelect.value;
  if (!subject) {
    alert('Please select a subject first');
    return;
  }
  const pyqs = pyqData[subject];
  const randomPyq = pyqs[Math.floor(Math.random() * pyqs.length)];
  loadPyqPreview(randomPyq.url);
});
startExamBtn.addEventListener('click', () => {
  const pyqUrl = pdfPreview.src;
  if (!pyqUrl) return;
  pdfPreviewContainer.style.display = 'none';
  pdfViewer.src = pyqUrl;
  pdfViewer.style.display = 'block';
  timeLeft = examDuration;
  subjectSelect.disabled = true;
  randomBtn.disabled = true;
  startTimer();
  writingInstructions.style.display = 'block';
  setTimeout(() => pdfViewer.scrollIntoView({behavior:'smooth'}), 300);
});

// === File Upload & Evaluation ===
const submitAnswersBtn = document.getElementById('submitAnswersBtn');
const evaluationResult = document.getElementById('evaluationResult');
const aiFeedback = document.getElementById('aiFeedback');
const resultSubject = document.getElementById('resultSubject');
const resultScore = document.getElementById('resultScore');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const fileRequirements = document.getElementById('fileRequirements');

fileInput.addEventListener('change', function() {
  fileList.innerHTML = '';
  const validFiles = Array.from(this.files).filter(file =>
    ['image/jpeg','image/png','application/pdf'].includes(file.type));
  if (validFiles.length !== this.files.length) {
    fileRequirements.textContent = 'Only JPG, PNG, PDF are allowed.';
    fileRequirements.classList.add('error');
    return;
  }
  fileRequirements.textContent = 'Files ready for upload';
  fileRequirements.classList.remove('error');
  submitAnswersBtn.style.display = validFiles.length ? 'block' : 'none';
  validFiles.forEach((file, index) => {
    const li = document.createElement('li');
    li.innerHTML = `${file.name} (${(file.size / 1024).toFixed(1)}KB) <i class="fas fa-times" data-index="${index}"></i>`;
    fileList.appendChild(li);
  });
});
fileList.addEventListener('click', e => {
  if (e.target.classList.contains('fa-times')) {
    const index = e.target.getAttribute('data-index');
    const files = Array.from(fileInput.files);
    files.splice(index, 1);
    const dt = new DataTransfer();
    files.forEach(f => dt.items.add(f));
    fileInput.files = dt.files;
    fileInput.dispatchEvent(new Event('change'));
  }
});

async function extractTextFromFiles(files) {
  let allText = '';
  for (const file of files) {
    const { data: { text } } = await Tesseract.recognize(file, 'eng');
    allText += `\n--- ${file.name} ---\n${text}\n`;
  }
  return allText.trim();
}

submitAnswersBtn.addEventListener('click', async function() {
  if (fileInput.files.length < 1) {
    fileRequirements.textContent = 'Please upload at least 1 file';
    fileRequirements.classList.add('error');
    return;
  }
  this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Evaluating...';
  this.disabled = true;

  const subject = subjectSelect.options[subjectSelect.selectedIndex].text;
  const extractedAnswersText = await extractTextFromFiles(fileInput.files);
  if (!extractedAnswersText) {
    aiFeedback.value = "Error: No text could be extracted.";
    evaluationResult.style.display = 'block';
    return;
  }

      const prompt = `
You are an experienced JNTUK R23 exam evaluator. Please evaluate this student's answer sheet for ${subject} based on:
1. Accuracy of answers
2. Completeness of solutions
3. Clarity of explanations
4. Correct use of terminology
5. Logical flow and structure

Student's answers:
${extractedAnswersText}

Provide:
1. A score out of 70
2. Detailed feedback on strengths and weaknesses
3. Specific suggestions for improvement
4. Areas that need more focus
5. 0 marks for completely incorrect answers
6. warning for anwers not related to the question
7. if the submitted answers are pictures and wallpapers and other form of images then give 0 marks and a warning that the answers should be in text format only.
Please ensure your feedback is constructive and helps the student improve their understanding of the subject.

Format your response as:
Score: [score]/70
Feedback: [detailed feedback]
`;





  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer 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",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "mistralai/mistral-7b-instruct",
        messages: [
          { role: "system", content: "You are an expert evaluator." },
          { role: "user", content: prompt }
        ]
      })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    if (!data.choices?.length) throw new Error("No response choices returned");
    const aiRes = data.choices[0].message.content;
    resultSubject.textContent = subject;
    const m = aiRes.match(/Score:\s*(\d+)/i);
    const score = m ? parseInt(m[1]) : 'N/A';
    resultScore.textContent = `${score}/70`;
    aiFeedback.value = aiRes;
    evaluationResult.style.display = 'block';
    if (typeof score === 'number') addToHistory(subject, score);
  } catch (e) {
    console.error(e);
    aiFeedback.value = "Error: Could not get evaluation.";
    evaluationResult.style.display = 'block';
  }

  this.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit for Evaluation';
  this.disabled = false;
  fileInput.value = '';
  fileList.innerHTML = '';
  submitAnswersBtn.style.display = 'none';
  fileRequirements.textContent = 'Please upload at least 1 file';
  fileRequirements.classList.remove('error');
});
</script>



</body>
</html>
